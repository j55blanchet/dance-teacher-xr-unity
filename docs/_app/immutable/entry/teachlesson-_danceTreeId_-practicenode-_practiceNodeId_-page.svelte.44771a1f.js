var at=Object.defineProperty;var lt=(r,t,e)=>t in r?at(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var Ae=(r,t,e)=>(lt(r,typeof t!="symbol"?t+"":t,e),e);import{S as ye,i as De,s as Pe,k as w,l as S,m as D,h as m,n as y,b as V,I as ie,W as Le,q as W,r as H,D as g,a as z,c as L,X as We,Y as he,N as $,J as He,T as st,u as ne,v as ct,d as se,f as ut,g as oe,H as ot,K as ft,o as Ce,t as dt,w as x,y as ge,z as Ee,A as ke,B as we,M as pe,P as _e,p as qe,R as ve,V as je}from"../chunks/index.41f98ac2.js";import{P as j,c as Be,g as mt,l as ht,G as Ue,F as pt,m as Ge}from"../chunks/dances-store.51bf466b.js";import{g as _t,V as vt}from"../chunks/VideoWithSkeleton.c77d6bb3.js";import{w as Se,a as Ye,R as be,P as Ne}from"../chunks/VirtualMirror.svelte_svelte_type_style_lang.658a6d63.js";import{D as Je,P as bt}from"../chunks/vision_bundle.f4284cec.js";import"../chunks/index.2defaa64.js";function Xe(r,t,e){const i=r.slice();return i[11]=t[e],i}function Ke(r,t,e){const i=r.slice();return i[11]=t[e],i}function gt(r){let t,e;return{c(){t=w("div"),e=W("Webcam Started")},l(i){t=S(i,"DIV",{});var s=D(t);e=H(s,"Webcam Started"),s.forEach(m)},m(i,s){V(i,t,s),g(t,e)},p:ie,d(i){i&&m(t)}}}function Et(r){let t,e,i,s,n,o,l,c,u,h,b,P,I,v,p,R,F,C,O=r[3],E=[];for(let a=0;a<O.length;a+=1)E[a]=Qe(Ke(r,O,a));let A=r[4],N=[];for(let a=0;a<A.length;a+=1)N[a]=Ze(Xe(r,A,a));return{c(){t=w("label"),e=W("Video Devices"),i=z(),s=w("select");for(let a=0;a<E.length;a+=1)E[a].c();n=z(),o=w("div"),l=z(),c=w("label"),u=W("Audio Devices"),h=z(),b=w("select");for(let a=0;a<N.length;a+=1)N[a].c();P=z(),I=w("div"),v=z(),p=w("button"),R=W("Start Webcam"),this.h()},l(a){t=S(a,"LABEL",{for:!0});var f=D(t);e=H(f,"Video Devices"),f.forEach(m),i=L(a),s=S(a,"SELECT",{name:!0,class:!0});var d=D(s);for(let q=0;q<E.length;q+=1)E[q].l(d);d.forEach(m),n=L(a),o=S(a,"DIV",{class:!0}),D(o).forEach(m),l=L(a),c=S(a,"LABEL",{for:!0});var T=D(c);u=H(T,"Audio Devices"),T.forEach(m),h=L(a),b=S(a,"SELECT",{name:!0,class:!0});var M=D(b);for(let q=0;q<N.length;q+=1)N[q].l(M);M.forEach(m),P=L(a),I=S(a,"DIV",{class:!0}),D(I).forEach(m),v=L(a),p=S(a,"BUTTON",{class:!0});var B=D(p);R=H(B,"Start Webcam"),B.forEach(m),this.h()},h(){y(t,"for","videoDevices"),y(s,"name","videoDevices"),y(s,"class","outlined thin"),r[6]===void 0&&We(()=>r[9].call(s)),y(o,"class","spacer svelte-1n7z142"),y(c,"for","audioDevices"),y(b,"name","audioDevices"),y(b,"class","outlined thin"),r[5]===void 0&&We(()=>r[10].call(b)),y(I,"class","spacer svelte-1n7z142"),y(p,"class","button outlined thin")},m(a,f){V(a,t,f),g(t,e),V(a,i,f),V(a,s,f);for(let d=0;d<E.length;d+=1)E[d]&&E[d].m(s,null);he(s,r[6],!0),V(a,n,f),V(a,o,f),V(a,l,f),V(a,c,f),g(c,u),V(a,h,f),V(a,b,f);for(let d=0;d<N.length;d+=1)N[d]&&N[d].m(b,null);he(b,r[5],!0),V(a,P,f),V(a,I,f),V(a,v,f),V(a,p,f),g(p,R),F||(C=[$(s,"change",r[9]),$(b,"change",r[10]),$(p,"click",r[8])],F=!0)},p(a,f){if(f&8){O=a[3];let d;for(d=0;d<O.length;d+=1){const T=Ke(a,O,d);E[d]?E[d].p(T,f):(E[d]=Qe(T),E[d].c(),E[d].m(s,null))}for(;d<E.length;d+=1)E[d].d(1);E.length=O.length}if(f&72&&he(s,a[6]),f&16){A=a[4];let d;for(d=0;d<A.length;d+=1){const T=Xe(a,A,d);N[d]?N[d].p(T,f):(N[d]=Ze(T),N[d].c(),N[d].m(b,null))}for(;d<N.length;d+=1)N[d].d(1);N.length=A.length}f&48&&he(b,a[5])},d(a){a&&m(t),a&&m(i),a&&m(s),He(E,a),a&&m(n),a&&m(o),a&&m(l),a&&m(c),a&&m(h),a&&m(b),He(N,a),a&&m(P),a&&m(I),a&&m(v),a&&m(p),F=!1,st(C)}}}function kt(r){let t,e,i,s,n;return{c(){t=w("div"),e=w("div"),i=z(),s=w("p"),n=W(r[1]),this.h()},l(o){t=S(o,"DIV",{class:!0});var l=D(t);e=S(l,"DIV",{class:!0}),D(e).forEach(m),i=L(l),s=S(l,"P",{});var c=D(s);n=H(c,r[1]),c.forEach(m),l.forEach(m),this.h()},h(){y(e,"class","spinner large margin-auto"),y(t,"class","ta-center")},m(o,l){V(o,t,l),g(t,e),g(t,i),g(t,s),g(s,n)},p(o,l){l&2&&ne(n,o[1])},d(o){o&&m(t)}}}function wt(r){let t,e,i,s,n,o,l=r[2]&&xe(r);return{c(){t=w("div"),e=w("button"),i=W("Start Webcam"),s=z(),l&&l.c(),this.h()},l(c){t=S(c,"DIV",{class:!0});var u=D(t);e=S(u,"BUTTON",{id:!0,class:!0});var h=D(e);i=H(h,"Start Webcam"),h.forEach(m),s=L(u),l&&l.l(u),u.forEach(m),this.h()},h(){y(e,"id","startWebcam"),y(e,"class","button outlined thin"),y(t,"class","ta-center")},m(c,u){V(c,t,u),g(t,e),g(e,i),g(t,s),l&&l.m(t,null),n||(o=$(e,"click",r[7]),n=!0)},p(c,u){c[2]?l?l.p(c,u):(l=xe(c),l.c(),l.m(t,null)):l&&(l.d(1),l=null)},d(c){c&&m(t),l&&l.d(),n=!1,o()}}}function Qe(r){let t,e=r[11].label+"",i,s;return{c(){t=w("option"),i=W(e),this.h()},l(n){t=S(n,"OPTION",{});var o=D(t);i=H(o,e),o.forEach(m),this.h()},h(){t.__value=s=r[11].deviceId,t.value=t.__value},m(n,o){V(n,t,o),g(t,i)},p(n,o){o&8&&e!==(e=n[11].label+"")&&ne(i,e),o&8&&s!==(s=n[11].deviceId)&&(t.__value=s,t.value=t.__value)},d(n){n&&m(t)}}}function Ze(r){let t,e=r[11].label+"",i,s;return{c(){t=w("option"),i=W(e),this.h()},l(n){t=S(n,"OPTION",{});var o=D(t);i=H(o,e),o.forEach(m),this.h()},h(){t.__value=s=r[11].deviceId,t.value=t.__value},m(n,o){V(n,t,o),g(t,i)},p(n,o){o&16&&e!==(e=n[11].label+"")&&ne(i,e),o&16&&s!==(s=n[11].deviceId)&&(t.__value=s,t.value=t.__value)},d(n){n&&m(t)}}}function xe(r){var l;let t,e,i,s,n=((l=r[2])==null?void 0:l.message)+"",o;return{c(){t=w("div"),e=w("p"),i=W("Failed to start webcam: "),s=w("code"),o=W(n),this.h()},l(c){t=S(c,"DIV",{class:!0});var u=D(t);e=S(u,"P",{class:!0});var h=D(e);i=H(h,"Failed to start webcam: "),s=S(h,"CODE",{});var b=D(s);o=H(b,n),b.forEach(m),h.forEach(m),u.forEach(m),this.h()},h(){y(e,"class","svelte-1n7z142"),y(t,"class","error svelte-1n7z142")},m(c,u){V(c,t,u),g(t,e),g(e,i),g(e,s),g(s,o)},p(c,u){var h;u&4&&n!==(n=((h=c[2])==null?void 0:h.message)+"")&&ne(o,n)},d(c){c&&m(t)}}}function St(r){let t;function e(n,o){if(n[0]==="start")return wt;if(n[0]==="busy")return kt;if(n[0]==="devicelist")return Et;if(n[0]==="success")return gt}let i=e(r),s=i&&i(r);return{c(){t=w("div"),s&&s.c(),this.h()},l(n){t=S(n,"DIV",{class:!0});var o=D(t);s&&s.l(o),o.forEach(m),this.h()},h(){y(t,"class","webcamSelector svelte-1n7z142")},m(n,o){V(n,t,o),s&&s.m(t,null)},p(n,[o]){i===(i=e(n))&&s?s.p(n,o):(s&&s.d(1),s=i&&i(n),s&&(s.c(),s.m(t,null)))},i:ie,o:ie,d(n){n&&m(t),s&&s.d()}}}function yt(r,t,e){let i="start",s="",n,o=[],l=[],c,u;async function h(){e(0,i="busy"),e(2,n=void 0),e(1,s="Detecting Devices...");try{const v=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),p=await navigator.mediaDevices.enumerateDevices();if(e(3,o=p.filter(R=>R.kind==="videoinput")),e(4,l=p.filter(R=>R.kind==="audioinput")),o.length===0){e(0,i="start"),e(2,n=new Error("No devices found"));return}if(o.length===1){Se.set(v),e(0,i="success");return}e(6,u=o[0].deviceId),e(5,c=l[0].deviceId),e(0,i="devicelist")}catch(v){e(2,n=v),e(0,i="start");return}}async function b(){e(2,n=void 0),e(0,i="busy"),e(1,s="Starting Webcam...");try{const v=await navigator.mediaDevices.getUserMedia({video:{deviceId:u},audio:{deviceId:c}});Se.set(v),e(0,i="success")}catch(v){e(2,n=v),e(0,i="devicelist")}}function P(){u=Le(this),e(6,u),e(3,o)}function I(){c=Le(this),e(5,c),e(4,l)}return[i,s,n,o,l,c,u,h,b,P,I]}class Dt extends ye{constructor(t){super(),De(this,t,yt,St,Pe,{})}}function Pt(r){let t,e,i;return e=new Dt({}),{c(){t=w("div"),ge(e.$$.fragment)},l(s){t=S(s,"DIV",{});var n=D(t);Ee(e.$$.fragment,n),n.forEach(m)},m(s,n){V(s,t,n),ke(e,t,null),i=!0},p:ie,i(s){i||(oe(e.$$.fragment,s),i=!0)},o(s){se(e.$$.fragment,s),i=!1},d(s){s&&m(t),we(e)}}}function Tt(r){let t,e,i,s,n;return{c(){t=w("video"),e=z(),i=w("canvas"),this.h()},l(o){t=S(o,"VIDEO",{class:!0}),D(t).forEach(m),e=L(o),i=S(o,"CANVAS",{class:!0}),D(i).forEach(m),this.h()},h(){t.autoplay=!0,y(t,"class","svelte-1b7esxu"),pe(t,"flippedHorizontal",r[1]),y(i,"class","svelte-1b7esxu"),pe(i,"flippedHorizontal",r[1])},m(o,l){V(o,t,l),r[22](t),t.muted=r[0],V(o,e,l),V(o,i,l),r[24](i),s||(n=[$(t,"play",r[7]),$(t,"loadeddata",r[6]),$(t,"volumechange",r[23])],s=!0)},p(o,l){l[0]&1&&(t.muted=o[0]),l[0]&2&&pe(t,"flippedHorizontal",o[1]),l[0]&2&&pe(i,"flippedHorizontal",o[1])},i:ie,o:ie,d(o){o&&m(t),r[22](null),o&&m(e),o&&m(i),r[24](null),s=!1,st(n)}}}function It(r){let t,e,i,s;const n=[Tt,Pt],o=[];function l(c,u){return c[4]?0:1}return e=l(r),i=o[e]=n[e](r),{c(){t=w("div"),i.c(),this.h()},l(c){t=S(c,"DIV",{class:!0});var u=D(t);i.l(u),u.forEach(m),this.h()},h(){y(t,"class","wrapper svelte-1b7esxu")},m(c,u){V(c,t,u),o[e].m(t,null),r[25](t),s=!0},p(c,u){let h=e;e=l(c),e===h?o[e].p(c,u):(ct(),se(o[h],1,1,()=>{o[h]=null}),ut(),i=o[e],i?i.p(c,u):(i=o[e]=n[e](c),i.c()),oe(i,1),i.m(t,null))},i(c){s||(oe(i),s=!0)},o(c){se(i),s=!1},d(c){c&&m(t),o[e].d(),r[25](null)}}}const Ft=50;function Vt(r,t,e){let i;ot(r,Se,_=>e(4,i=_));const s=-1e3,n=ft();let{poseEstimationEnabled:o=!1}=t,{drawSkeleton:l=!1}=t,{muted:c=!0}=t,{poseEstimationCheckFunction:u=()=>!0}=t,h=null,b,{poseEstimationPrimedPromise:P=new Promise(_=>b=_)}=t,I=!1,v,p,R,F,C,O;const E=new Promise(_=>O=_);let{mirrorHorizontally:A=!0}=t,N=new Date().getTime(),a=-1,f=new Date().getTime(),d=-1,T=1,M=1,B=1,q=1,Y=1,X=1;function fe(){v&&(e(18,T=v.videoWidth),e(19,M=v.videoHeight))}let K=null;const ae=()=>{p&&(X>B?(e(3,p.height=Y,p),e(3,p.width=Y*B,p)):(e(3,p.width=q,p),e(3,p.height=q/B,p)))};function le(){return e(15,h=Ye),e(15,h.onmessage=_=>{if(_.data.type===be.poseEstimation){if(f=new Date().getTime(),_.data.frameId===s){b==null||b();return}d=_.data.frameId,K=_.data.landmarkerResult;const ee={frameId:_.data.frameId,estimatedPose:_.data.estimatedPose,srcWidth:_.data.srcWidth,srcHeight:_.data.srcHeight};n("poseEstimationResult",ee)}else _.data.type===be.error||_.data.type===be.resetError?(console.error("PoseEstim Error Message",_.data.type,_.data.error),_.data.frameId===a&&(a=-1,K=null)):_.data.type==be.resetComplete&&(console.log("Pose Estimation Reset Complete"),a=-1,K=null)},h),Ye.postMessage({type:Ne.reset,frameId:new Date().getTime()}),h.ready}async function Te(){if(!o||!h||!F||!p)throw new Error("Pose estimation not enabled, or not yet ready.");return console.log("Priming pose estimation"),e(8,P=new Promise(_=>b=_)),h.postMessage({type:Ne.requestPoseEstimation,frameId:s,image:F.getImageData(0,0,p.width,p.height)}),P}Ce(async()=>{o&&le(),await dt(),ae();const _=new ResizeObserver(ee=>{if(!R)return;const[G,U]=_t(R);e(20,q=G),e(21,Y=U)});return _.observe(R),()=>{h==null||h.terminate(),_.unobserve(R)}});function de(){!v||!i||(e(2,v.srcObject=i,v),e(16,I=!0),O&&(O(),O=void 0))}let te=0;function re(){if(!p||!v||!i||!F)return;te+=1;const _=v.videoWidth/v.videoHeight,ee=p.width/p.height;let G=p.width,U=p.height,Q=0,Z=0;if(_>ee?(U=p.width/_,Z=(p.height-U)/2):(G=U*_,Q=(p.width-G)/2),F.drawImage(v,Q,Z,G,U),!(Q>=0&&Z>=0&&G>0&&U>0&&ee>0&&_>0)){requestAnimationFrame(re);return}const ce=new Date().getTime(),me=ce-f;if(d==a&&me>Ft&&o&&u()){const J=ce-N;a=te,n("poseEstimationFrameSent",{frameId:te,timestampMs:J}),h==null||h.postMessage({type:Ne.requestPoseEstimation,frameId:te,timestampMs:J,image:F.getImageData(Q,Z,G,U)})}if(!l){requestAnimationFrame(re);return}F.save();for(const J of(K==null?void 0:K.landmarks)??[])C==null||C.drawConnectors(J,bt.POSE_CONNECTIONS),C==null||C.drawLandmarks(J,{radius:ze=>Je.lerp(ze.from.z,-.15,.1,5,1)});F.restore(),requestAnimationFrame(re)}Ce(()=>(de(),{}));function Ie(_){x[_?"unshift":"push"](()=>{v=_,e(2,v)})}function Fe(){c=this.muted,e(0,c)}function Ve(_){x[_?"unshift":"push"](()=>{p=_,e(3,p)})}function k(_){x[_?"unshift":"push"](()=>{R=_,e(5,R)})}return r.$$set=_=>{"poseEstimationEnabled"in _&&e(9,o=_.poseEstimationEnabled),"drawSkeleton"in _&&e(10,l=_.drawSkeleton),"muted"in _&&e(0,c=_.muted),"poseEstimationCheckFunction"in _&&e(11,u=_.poseEstimationCheckFunction),"poseEstimationPrimedPromise"in _&&e(8,P=_.poseEstimationPrimedPromise),"mirrorHorizontally"in _&&e(1,A=_.mirrorHorizontally)},r.$$.update=()=>{r.$$.dirty[0]&786432&&(B=T/M),r.$$.dirty[0]&3145728&&(X=q/Y),r.$$.dirty[0]&33280&&o&&!h&&le(),r.$$.dirty[0]&20&&i&&v&&de(),r.$$.dirty[0]&3932160&&T&&M&&q&&Y&&ae(),r.$$.dirty[0]&196620&&I&&v&&p&&(e(17,F=p.getContext("2d",{willReadFrequently:!0})),C=new Je(F),re())},[c,A,v,p,i,R,fe,ae,P,o,l,u,E,le,Te,h,I,F,T,M,q,Y,Ie,Fe,Ve,k]}class Rt extends ye{constructor(t){super(),De(this,t,Vt,It,Pe,{poseEstimationEnabled:9,drawSkeleton:10,muted:0,poseEstimationCheckFunction:11,poseEstimationPrimedPromise:8,webcamStartedPromise:12,mirrorHorizontally:1,setupPoseEstimation:13,primePoseEstimation:14},null,[-1,-1])}get webcamStartedPromise(){return this.$$.ctx[12]}get setupPoseEstimation(){return this.$$.ctx[13]}get primePoseEstimation(){return this.$$.ctx[14]}}function At(r,t,e,i){return{startTime:e.start_time,endTime:e.end_time,activityTypes:["drill"],playbackSpeed:.6}}function $e(r,t){return t instanceof Map?Object.fromEntries(t):t}const Oe=Object.freeze([[j.leftShoulder,j.rightShoulder],[j.leftShoulder,j.leftHip],[j.leftHip,j.rightHip],[j.rightHip,j.rightShoulder],[j.leftShoulder,j.leftElbow],[j.leftElbow,j.leftWrist],[j.rightShoulder,j.rightElbow],[j.rightElbow,j.rightWrist]]);function Nt(r,t,e,i,s){const n=e-t,o=s-i;return i+o*((r-t)/n)}function nt(r){return Math.pow(Math.pow(r[0],2)+Math.pow(r[1],2),.5)}function Ct(r){return r.reduce((t,e)=>t+e,0)}function Me(r){return Ct(r)/r.length}function et(r,t,e){const{x:i,y:s}=r[t],{x:n,y:o}=r[e],[l,c]=[n-i,o-s],u=nt([l,c]);return[l/u,c/u]}function Ot(r,t){return 0}function Mt(r,t){let e=0;const i=Oe.map(b=>{const[P,I]=b,[v,p]=et(r,P,I),[R,F]=et(t,P,I),[C,O]=[v-R,p-F];return nt([C,O])||0});e=Me(i),e/=Oe.length;const s=2,n=0,o=5,l=0;function c(b){return Nt(b,n,s,o,l)}const u=c(e),h=i.map(c);return[u,h]}class zt{constructor(){Ae(this,"tracks",new Map)}recordEvaluationFrame(t,e,i,s){var c;const n=Object.keys(s);this.tracks.has(t)||this.tracks.set(t,{creationDate:new Date,frameTimes:[],recordTimesMs:[],userPoses:[],evaluation:n.reduce((u,h)=>(u[h]=[],u),{})});const o=((c=this.tracks.get(t))==null?void 0:c.frameTimes.slice(-1)[0])??-1/0;if(e<o)throw new Error("Frame time must be increasing");const l=this.tracks.get(t);l.frameTimes.push(e),l.recordTimesMs.push(new Date().getTime()),l.userPoses.push(i);for(const u of n)l.evaluation[u].push(s[u])}}class Lt{constructor(t){Ae(this,"recorder",new zt);this.referenceData=t}evaluateFrame(t,e,i){const s=this.referenceData.getReferencePoseAtTime(e);if(!s){this.recorder.recordEvaluationFrame(t,e,i,{qijiaOverallScore:NaN,qijiaByVectorScores:Array(8).fill(NaN),julienScore:NaN});return}const[n,o]=Mt(s,i),l=Ot();this.recorder.recordEvaluationFrame(t,e,i,{qijiaOverallScore:n,qijiaByVectorScores:o,julienScore:l})}getPerformanceSummary(t){const e=this.recorder.tracks.get(t);if(!e)return null;const i=Oe.map((h,b)=>{const[P,I]=h,[v,p]=[Be[P],Be[I]],R=`${v} -> ${p}`,F=e.evaluation.qijiaByVectorScores.map(O=>O[b]),C=Me(F);return[R,C]});let s={qijiaOverallScore:Me(e.evaluation.qijiaOverallScore),qijiaByVectorScores:new Map(i)};const n=e.frameTimes.length,o=(e.recordTimesMs[n-1]-e.recordTimesMs[0])/1e3,l=e.frameTimes[n-1]-e.frameTimes[0],c=n/l,u=n/o;return s.frameCount=n,s.danceTimeDurationSecs=l,s.realtimeDurationSecs=o,s.danceTimeFps=c,s.realTimeFps=u,s}}const Wt=""+new URL("../assets/metronome.208d4270.mp3",import.meta.url).href;function Ht(r){let t,e;return{c(){t=w("source"),this.h()},l(i){t=S(i,"SOURCE",{src:!0,type:!0}),this.h()},h(){je(t.src,e=r[9])||y(t,"src",e),y(t,"type","video/mp4")},m(i,s){V(i,t,s)},p(i,s){s[0]&512&&!je(t.src,e=i[9])&&y(t,"src",e)},d(i){i&&m(t)}}}function tt(r){let t,e,i;return{c(){t=w("div"),e=w("span"),i=W(r[13]),this.h()},l(s){t=S(s,"DIV",{class:!0});var n=D(t);e=S(n,"SPAN",{class:!0});var o=D(e);i=H(o,r[13]),o.forEach(m),n.forEach(m),this.h()},h(){y(e,"class","count svelte-3894ek"),y(t,"class","countdown svelte-3894ek")},m(s,n){V(s,t,n),g(t,e),g(e,i)},p(s,n){n[0]&8192&&ne(i,s[13])},d(s){s&&m(t)}}}function rt(r){let t,e,i,s,n,o,l,c,u=JSON.stringify(r[12],$e,2)+"",h,b,P;return{c(){t=w("div"),e=w("h1"),i=W("Feedback"),s=z(),n=w("button"),o=W("Play Again"),l=z(),c=w("pre"),h=W(u),this.h()},l(I){t=S(I,"DIV",{class:!0});var v=D(t);e=S(v,"H1",{});var p=D(e);i=H(p,"Feedback"),p.forEach(m),s=L(v),n=S(v,"BUTTON",{class:!0});var R=D(n);o=H(R,"Play Again"),R.forEach(m),l=L(v),c=S(v,"PRE",{});var F=D(c);h=H(F,u),F.forEach(m),v.forEach(m),this.h()},h(){y(n,"class","button outlined thin"),y(t,"class","svelte-3894ek")},m(I,v){V(I,t,v),g(t,e),g(e,i),g(t,s),g(t,n),g(n,o),g(t,l),g(t,c),g(c,h),b||(P=$(n,"click",r[1]),b=!0)},p(I,v){v[0]&4096&&u!==(u=JSON.stringify(I[12],$e,2)+"")&&ne(h,u)},d(I){I&&m(t),b=!1,P()}}}function it(r){let t,e,i,s,n;return{c(){t=w("div"),e=w("div"),i=z(),s=w("div"),n=W("Loading..."),this.h()},l(o){t=S(o,"DIV",{class:!0});var l=D(t);e=S(l,"DIV",{class:!0}),D(e).forEach(m),i=L(l),s=S(l,"DIV",{class:!0});var c=D(s);n=H(c,"Loading..."),c.forEach(m),l.forEach(m),this.h()},h(){y(e,"class","spinner large"),y(s,"class","label svelte-3894ek"),y(t,"class","loading outlined thick svelte-3894ek")},m(o,l){V(o,t,l),g(t,e),g(t,i),g(t,s),g(s,n)},d(o){o&&m(t)}}}function qt(r){let t,e,i,s,n,o,l,c,u,h,b,P,I,v;function p(f){r[26](f)}function R(f){r[27](f)}function F(f){r[28](f)}function C(f){r[29](f)}let O={flipHorizontal:r[0],fitToFlexbox:jt,poseData:r[11],drawSkeleton:!0,$$slots:{default:[Ht]},$$scope:{ctx:r}};r[3]!==void 0&&(O.currentTime=r[3]),r[8]!==void 0&&(O.playbackRate=r[8]),r[5]!==void 0&&(O.paused=r[5]),r[4]!==void 0&&(O.duration=r[4]),i=new vt({props:O}),x.push(()=>_e(i,"currentTime",p)),x.push(()=>_e(i,"playbackRate",R)),x.push(()=>_e(i,"paused",F)),x.push(()=>_e(i,"duration",C));let E=r[13]>=0&&tt(r),A=r[2]==="feedback"&&rt(r),N={poseEstimationEnabled:r[10],drawSkeleton:!r[5]||r[6],poseEstimationCheckFunction:r[15]};P=new Rt({props:N}),r[30](P),P.$on("poseEstimationFrameSent",r[14]),P.$on("poseEstimationResult",r[16]);let a=r[2]==="waitStart"&&it();return{c(){t=w("section"),e=w("div"),ge(i.$$.fragment),c=z(),E&&E.c(),u=z(),A&&A.c(),h=z(),b=w("div"),ge(P.$$.fragment),I=z(),a&&a.c(),this.h()},l(f){t=S(f,"SECTION",{class:!0});var d=D(t);e=S(d,"DIV",{class:!0});var T=D(e);Ee(i.$$.fragment,T),c=L(T),E&&E.l(T),T.forEach(m),u=L(d),A&&A.l(d),h=L(d),b=S(d,"DIV",{class:!0});var M=D(b);Ee(P.$$.fragment,M),I=L(M),a&&a.l(M),M.forEach(m),d.forEach(m),this.h()},h(){y(e,"class","svelte-3894ek"),y(b,"class","svelte-3894ek"),qe(b,"display",r[2]==="feedback"?"none":"flex"),y(t,"class","practicePage svelte-3894ek")},m(f,d){V(f,t,d),g(t,e),ke(i,e,null),g(e,c),E&&E.m(e,null),g(t,u),A&&A.m(t,null),g(t,h),g(t,b),ke(P,b,null),g(b,I),a&&a.m(b,null),v=!0},p(f,d){const T={};d[0]&1&&(T.flipHorizontal=f[0]),d[0]&2048&&(T.poseData=f[11]),d[0]&512|d[1]&512&&(T.$$scope={dirty:d,ctx:f}),!s&&d[0]&8&&(s=!0,T.currentTime=f[3],ve(()=>s=!1)),!n&&d[0]&256&&(n=!0,T.playbackRate=f[8],ve(()=>n=!1)),!o&&d[0]&32&&(o=!0,T.paused=f[5],ve(()=>o=!1)),!l&&d[0]&16&&(l=!0,T.duration=f[4],ve(()=>l=!1)),i.$set(T),f[13]>=0?E?E.p(f,d):(E=tt(f),E.c(),E.m(e,null)):E&&(E.d(1),E=null),f[2]==="feedback"?A?A.p(f,d):(A=rt(f),A.c(),A.m(t,h)):A&&(A.d(1),A=null);const M={};d[0]&1024&&(M.poseEstimationEnabled=f[10]),d[0]&96&&(M.drawSkeleton=!f[5]||f[6]),P.$set(M),f[2]==="waitStart"?a||(a=it(),a.c(),a.m(b,null)):a&&(a.d(1),a=null),d[0]&4&&qe(b,"display",f[2]==="feedback"?"none":"flex")},i(f){v||(oe(i.$$.fragment,f),oe(P.$$.fragment,f),v=!0)},o(f){se(i.$$.fragment,f),se(P.$$.fragment,f),v=!1},d(f){f&&m(t),we(i),E&&E.d(),A&&A.d(),r[30](null),we(P),a&&a.d()}}}let jt=!0;const Bt=10;async function ue(r){return new Promise(t=>{setTimeout(t,(r??1)*1e3)})}function Ut(r,t,e){let i;ot(r,Se,k=>e(25,i=k));let{mirrorForEvaluation:s=!1}=t,{dance:n}=t,{practiceActivity:o}=t,l="waitWebcam",c=0,u="watch",h=1,{pageActive:b=!1}=t,{flipVideo:P=!1}=t,I=new Audio(Wt),v,p=0,R=1,F=0,C=!0,O="",E=!1,A=null,N=null,a=null,f=crypto.randomUUID(),d=null,T=-1,M=!1;function B(){I.currentTime=0,I.play()}async function q(){M||(E&&(console.log("Triggering pose estimation priming"),await v.primePoseEstimation()),e(2,l="playing"),e(24,f=crypto.randomUUID()),e(6,M=!0),e(5,C=!0),e(3,p=(o==null?void 0:o.startTime)??0),await ue(h),e(13,T=5),B(),await ue(h),e(13,T=6),B(),await ue(h),e(13,T=7),B(),await ue(h),e(13,T=8),B(),await ue(h),e(13,T=-1),e(5,C=!1),e(6,M=!1))}async function Y(){e(21,c=0),e(2,l="waitWebcam"),e(5,C=!0),e(3,p=(o==null?void 0:o.startTime)??0),e(11,N=await ht(n)),await v.webcamStartedPromise,e(2,l="waitStart"),e(23,a=new Lt(N)),await A,q()}let X=new Map,fe=-1,K=new Date;const ae=1e3/Bt;function le(k){X.set(k.detail.frameId,p),fe=p}function Te(){return!(fe===p&&K.getTime()>Date.now()-ae)}function de(k){var Re,ce,me;if(l!=="playing")return;if(!N){console.log("No dance pose information",k);return}const _=k.detail.frameId;if(!X.has(_)){console.log(`No matching correspondance for ${_}`,k,"current correspondances: ",X);return}const ee=X.get(_);X.delete(_);const G=(Re=k==null?void 0:k.detail)==null?void 0:Re.srcWidth,U=(ce=k==null?void 0:k.detail)==null?void 0:ce.srcHeight,Q=((me=k==null?void 0:k.detail)==null?void 0:me.estimatedPose)??null;if(!Q)return;let Z=Ue(Q,G,U);if(s){const J=pt(Q);Z=Ue(J,G,U)}if(Z)try{a==null||a.evaluateFrame(f,ee,Z)}catch(J){console.warn("Error evaluating frame",J)}}Ce(()=>(e(3,p=(o==null?void 0:o.startTime)??0),A=v.setupPoseEstimation(),Y(),{}));function te(k){p=k,e(3,p)}function re(k){R=k,e(8,R),e(19,o)}function Ie(k){C=k,e(5,C),e(19,o),e(3,p),e(4,F),e(23,a),e(24,f)}function Fe(k){F=k,e(4,F)}function Ve(k){x[k?"unshift":"push"](()=>{v=k,e(7,v)})}return r.$$set=k=>{"mirrorForEvaluation"in k&&e(17,s=k.mirrorForEvaluation),"dance"in k&&e(18,n=k.dance),"practiceActivity"in k&&e(19,o=k.practiceActivity),"pageActive"in k&&e(20,b=k.pageActive),"flipVideo"in k&&e(0,P=k.flipVideo)},r.$$.update=()=>{r.$$.dirty[0]&25690136&&(o!=null&&o.endTime&&p>=o.endTime||F>0&&p>=F)&&(e(5,C=!0),e(12,d=(a==null?void 0:a.getPerformanceSummary(f))??null),e(2,l="feedback")),r.$$.dirty[0]&33554436&&i&&l==="waitWebcam"&&e(2,l="waitStart"),r.$$.dirty[0]&4&&console.log("PracticePage state",l),r.$$.dirty[0]&2621440&&o&&e(22,u=o.activityTypes[c]),r.$$.dirty[0]&262144&&(h=n!=null&&n.bpm?60/n.bpm:1),r.$$.dirty[0]&16&&console.log("VideoDuration",F),r.$$.dirty[0]&262144&&e(9,O=mt(n)),r.$$.dirty[0]&5242976&&e(10,E=b&&(M||!C)&&u==="drill"),r.$$.dirty[0]&524288&&e(8,R=(o==null?void 0:o.playbackSpeed)??1)},[P,Y,l,p,F,C,M,v,R,O,E,N,d,T,le,Te,de,s,n,o,b,c,u,a,f,i,te,re,Ie,Fe,Ve]}class Gt extends ye{constructor(t){super(),De(this,t,Ut,qt,Pe,{mirrorForEvaluation:17,dance:18,practiceActivity:19,pageActive:20,flipVideo:0,reset:1},null,[-1,-1])}get reset(){return this.$$.ctx[1]}}function Yt(r){let t,e,i,s,n,o=r[2].tree_name+"",l,c;return e=new Gt({props:{dance:r[1],practiceActivity:r[3],pageActive:!0}}),{c(){t=w("section"),ge(e.$$.fragment),i=z(),s=w("a"),n=W("< "),l=W(o),this.h()},l(u){t=S(u,"SECTION",{class:!0});var h=D(t);Ee(e.$$.fragment,h),i=L(h),s=S(h,"A",{href:!0,class:!0});var b=D(s);n=H(b,"< "),l=H(b,o),b.forEach(m),h.forEach(m),this.h()},h(){y(s,"href",r[0]),y(s,"class","button outlined back svelte-4dzpk3"),y(t,"class","practiceNode svelte-4dzpk3")},m(u,h){V(u,t,h),ke(e,t,null),g(t,i),g(t,s),g(s,n),g(s,l),c=!0},p(u,[h]){(!c||h&1)&&y(s,"href",u[0])},i(u){c||(oe(e.$$.fragment,u),c=!0)},o(u){se(e.$$.fragment,u),c=!1},d(u){u&&m(t),we(e)}}}function Jt(r,t,e){let{data:i}=t;const s=i.dance,n=i.danceTree,o=i.danceTreeNode,l=At(s,n,o);let c="/teachlesson/"+Ge(n);return r.$$set=u=>{"data"in u&&e(4,i=u.data)},e(0,c="/teachlesson/"+Ge(n)),[c,s,n,l,i]}class tr extends ye{constructor(t){super(),De(this,t,Jt,Yt,Pe,{data:4})}}export{tr as default};
