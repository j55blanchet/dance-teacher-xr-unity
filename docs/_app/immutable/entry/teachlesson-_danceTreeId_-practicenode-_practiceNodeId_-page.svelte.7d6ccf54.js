var et=Object.defineProperty;var tt=(r,t,e)=>t in r?et(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var Pe=(r,t,e)=>(tt(r,typeof t!="symbol"?t+"":t,e),e);import{S as Ee,i as ke,s as we,k,l as w,m as y,h as m,n as T,b as N,I as x,W as Fe,q as M,r as U,D as g,a as W,c as z,X as Ne,Y as ue,N as Y,J as Oe,T as Ke,u as K,v as it,d as $,f as st,g as ee,H as Qe,K as rt,o as Re,t as ot,w as B,y as _e,z as pe,A as ve,B as be,P as fe,p as Ae,R as de,V as Ce}from"../chunks/index.41f98ac2.js";import{g as nt,l as at,m as Le}from"../chunks/dances-store.8a5ae34b.js";import{G as lt,P as q}from"../chunks/mediapipe-utils.b2b00584.js";import{g as ct,V as ut}from"../chunks/VideoWithSkeleton.1db39bd4.js";import{w as ge,a as Me,R as me,P as Te}from"../chunks/VirtualMirror.svelte_svelte_type_style_lang.b7cb885f.js";import{D as Ue,P as ft}from"../chunks/vision_bundle.f4284cec.js";import"../chunks/index.2defaa64.js";function We(r,t,e){const s=r.slice();return s[11]=t[e],s}function ze(r,t,e){const s=r.slice();return s[11]=t[e],s}function dt(r){let t,e;return{c(){t=k("div"),e=M("Webcam Started")},l(s){t=w(s,"DIV",{});var i=y(t);e=U(i,"Webcam Started"),i.forEach(m)},m(s,i){N(s,t,i),g(t,e)},p:x,d(s){s&&m(t)}}}function mt(r){let t,e,s,i,o,n,c,l,u,h,p,S,D,b,_,F,C,A,R=r[3],E=[];for(let a=0;a<R.length;a+=1)E[a]=He(ze(r,R,a));let I=r[4],V=[];for(let a=0;a<I.length;a+=1)V[a]=qe(We(r,I,a));return{c(){t=k("label"),e=M("Video Devices"),s=W(),i=k("select");for(let a=0;a<E.length;a+=1)E[a].c();o=W(),n=k("div"),c=W(),l=k("label"),u=M("Audio Devices"),h=W(),p=k("select");for(let a=0;a<V.length;a+=1)V[a].c();S=W(),D=k("div"),b=W(),_=k("button"),F=M("Start Webcam"),this.h()},l(a){t=w(a,"LABEL",{for:!0});var f=y(t);e=U(f,"Video Devices"),f.forEach(m),s=z(a),i=w(a,"SELECT",{name:!0,class:!0});var d=y(i);for(let H=0;H<E.length;H+=1)E[H].l(d);d.forEach(m),o=z(a),n=w(a,"DIV",{class:!0}),y(n).forEach(m),c=z(a),l=w(a,"LABEL",{for:!0});var O=y(l);u=U(O,"Audio Devices"),O.forEach(m),h=z(a),p=w(a,"SELECT",{name:!0,class:!0});var L=y(p);for(let H=0;H<V.length;H+=1)V[H].l(L);L.forEach(m),S=z(a),D=w(a,"DIV",{class:!0}),y(D).forEach(m),b=z(a),_=w(a,"BUTTON",{class:!0});var j=y(_);F=U(j,"Start Webcam"),j.forEach(m),this.h()},h(){T(t,"for","videoDevices"),T(i,"name","videoDevices"),T(i,"class","outlined thin"),r[6]===void 0&&Ne(()=>r[9].call(i)),T(n,"class","spacer svelte-1n7z142"),T(l,"for","audioDevices"),T(p,"name","audioDevices"),T(p,"class","outlined thin"),r[5]===void 0&&Ne(()=>r[10].call(p)),T(D,"class","spacer svelte-1n7z142"),T(_,"class","button outlined thin")},m(a,f){N(a,t,f),g(t,e),N(a,s,f),N(a,i,f);for(let d=0;d<E.length;d+=1)E[d]&&E[d].m(i,null);ue(i,r[6],!0),N(a,o,f),N(a,n,f),N(a,c,f),N(a,l,f),g(l,u),N(a,h,f),N(a,p,f);for(let d=0;d<V.length;d+=1)V[d]&&V[d].m(p,null);ue(p,r[5],!0),N(a,S,f),N(a,D,f),N(a,b,f),N(a,_,f),g(_,F),C||(A=[Y(i,"change",r[9]),Y(p,"change",r[10]),Y(_,"click",r[8])],C=!0)},p(a,f){if(f&8){R=a[3];let d;for(d=0;d<R.length;d+=1){const O=ze(a,R,d);E[d]?E[d].p(O,f):(E[d]=He(O),E[d].c(),E[d].m(i,null))}for(;d<E.length;d+=1)E[d].d(1);E.length=R.length}if(f&72&&ue(i,a[6]),f&16){I=a[4];let d;for(d=0;d<I.length;d+=1){const O=We(a,I,d);V[d]?V[d].p(O,f):(V[d]=qe(O),V[d].c(),V[d].m(p,null))}for(;d<V.length;d+=1)V[d].d(1);V.length=I.length}f&48&&ue(p,a[5])},d(a){a&&m(t),a&&m(s),a&&m(i),Oe(E,a),a&&m(o),a&&m(n),a&&m(c),a&&m(l),a&&m(h),a&&m(p),Oe(V,a),a&&m(S),a&&m(D),a&&m(b),a&&m(_),C=!1,Ke(A)}}}function ht(r){let t,e,s,i,o;return{c(){t=k("div"),e=k("div"),s=W(),i=k("p"),o=M(r[1]),this.h()},l(n){t=w(n,"DIV",{class:!0});var c=y(t);e=w(c,"DIV",{class:!0}),y(e).forEach(m),s=z(c),i=w(c,"P",{});var l=y(i);o=U(l,r[1]),l.forEach(m),c.forEach(m),this.h()},h(){T(e,"class","spinner large margin-auto"),T(t,"class","ta-center")},m(n,c){N(n,t,c),g(t,e),g(t,s),g(t,i),g(i,o)},p(n,c){c&2&&K(o,n[1])},d(n){n&&m(t)}}}function _t(r){let t,e,s,i,o,n,c=r[2]&&je(r);return{c(){t=k("div"),e=k("button"),s=M("Start Webcam"),i=W(),c&&c.c(),this.h()},l(l){t=w(l,"DIV",{class:!0});var u=y(t);e=w(u,"BUTTON",{id:!0,class:!0});var h=y(e);s=U(h,"Start Webcam"),h.forEach(m),i=z(u),c&&c.l(u),u.forEach(m),this.h()},h(){T(e,"id","startWebcam"),T(e,"class","button outlined thin"),T(t,"class","ta-center")},m(l,u){N(l,t,u),g(t,e),g(e,s),g(t,i),c&&c.m(t,null),o||(n=Y(e,"click",r[7]),o=!0)},p(l,u){l[2]?c?c.p(l,u):(c=je(l),c.c(),c.m(t,null)):c&&(c.d(1),c=null)},d(l){l&&m(t),c&&c.d(),o=!1,n()}}}function He(r){let t,e=r[11].label+"",s,i;return{c(){t=k("option"),s=M(e),this.h()},l(o){t=w(o,"OPTION",{});var n=y(t);s=U(n,e),n.forEach(m),this.h()},h(){t.__value=i=r[11].deviceId,t.value=t.__value},m(o,n){N(o,t,n),g(t,s)},p(o,n){n&8&&e!==(e=o[11].label+"")&&K(s,e),n&8&&i!==(i=o[11].deviceId)&&(t.__value=i,t.value=t.__value)},d(o){o&&m(t)}}}function qe(r){let t,e=r[11].label+"",s,i;return{c(){t=k("option"),s=M(e),this.h()},l(o){t=w(o,"OPTION",{});var n=y(t);s=U(n,e),n.forEach(m),this.h()},h(){t.__value=i=r[11].deviceId,t.value=t.__value},m(o,n){N(o,t,n),g(t,s)},p(o,n){n&16&&e!==(e=o[11].label+"")&&K(s,e),n&16&&i!==(i=o[11].deviceId)&&(t.__value=i,t.value=t.__value)},d(o){o&&m(t)}}}function je(r){var c;let t,e,s,i,o=((c=r[2])==null?void 0:c.message)+"",n;return{c(){t=k("div"),e=k("p"),s=M("Failed to start webcam: "),i=k("code"),n=M(o),this.h()},l(l){t=w(l,"DIV",{class:!0});var u=y(t);e=w(u,"P",{class:!0});var h=y(e);s=U(h,"Failed to start webcam: "),i=w(h,"CODE",{});var p=y(i);n=U(p,o),p.forEach(m),h.forEach(m),u.forEach(m),this.h()},h(){T(e,"class","svelte-1n7z142"),T(t,"class","error svelte-1n7z142")},m(l,u){N(l,t,u),g(t,e),g(e,s),g(e,i),g(i,n)},p(l,u){var h;u&4&&o!==(o=((h=l[2])==null?void 0:h.message)+"")&&K(n,o)},d(l){l&&m(t)}}}function pt(r){let t;function e(o,n){if(o[0]==="start")return _t;if(o[0]==="busy")return ht;if(o[0]==="devicelist")return mt;if(o[0]==="success")return dt}let s=e(r),i=s&&s(r);return{c(){t=k("div"),i&&i.c(),this.h()},l(o){t=w(o,"DIV",{class:!0});var n=y(t);i&&i.l(n),n.forEach(m),this.h()},h(){T(t,"class","webcamSelector svelte-1n7z142")},m(o,n){N(o,t,n),i&&i.m(t,null)},p(o,[n]){s===(s=e(o))&&i?i.p(o,n):(i&&i.d(1),i=s&&s(o),i&&(i.c(),i.m(t,null)))},i:x,o:x,d(o){o&&m(t),i&&i.d()}}}function vt(r,t,e){let s="start",i="",o,n=[],c=[],l,u;async function h(){e(0,s="busy"),e(2,o=void 0),e(1,i="Detecting Devices...");try{const b=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),_=await navigator.mediaDevices.enumerateDevices();if(e(3,n=_.filter(F=>F.kind==="videoinput")),e(4,c=_.filter(F=>F.kind==="audioinput")),n.length===0){e(0,s="start"),e(2,o=new Error("No devices found"));return}if(n.length===1){ge.set(b),e(0,s="success");return}e(6,u=n[0].deviceId),e(5,l=c[0].deviceId),e(0,s="devicelist")}catch(b){e(2,o=b),e(0,s="start");return}}async function p(){e(2,o=void 0),e(0,s="busy"),e(1,i="Starting Webcam...");try{const b=await navigator.mediaDevices.getUserMedia({video:{deviceId:u},audio:{deviceId:l}});ge.set(b),e(0,s="success")}catch(b){e(2,o=b),e(0,s="devicelist")}}function S(){u=Fe(this),e(6,u),e(3,n)}function D(){l=Fe(this),e(5,l),e(4,c)}return[s,i,o,n,c,l,u,h,p,S,D]}class bt extends Ee{constructor(t){super(),ke(this,t,vt,pt,we,{})}}function gt(r){let t,e,s;return e=new bt({}),{c(){t=k("div"),_e(e.$$.fragment)},l(i){t=w(i,"DIV",{});var o=y(t);pe(e.$$.fragment,o),o.forEach(m)},m(i,o){N(i,t,o),ve(e,t,null),s=!0},p:x,i(i){s||(ee(e.$$.fragment,i),s=!0)},o(i){$(e.$$.fragment,i),s=!1},d(i){i&&m(t),be(e)}}}function Et(r){let t,e,s,i,o;return{c(){t=k("video"),e=W(),s=k("canvas"),this.h()},l(n){t=w(n,"VIDEO",{class:!0}),y(t).forEach(m),e=z(n),s=w(n,"CANVAS",{class:!0}),y(s).forEach(m),this.h()},h(){t.autoplay=!0,T(t,"class","svelte-eu68uy"),T(s,"class","svelte-eu68uy")},m(n,c){N(n,t,c),r[21](t),t.muted=r[0],N(n,e,c),N(n,s,c),r[23](s),i||(o=[Y(t,"play",r[6]),Y(t,"loadeddata",r[5]),Y(t,"volumechange",r[22])],i=!0)},p(n,c){c[0]&1&&(t.muted=n[0])},i:x,o:x,d(n){n&&m(t),r[21](null),n&&m(e),n&&m(s),r[23](null),i=!1,Ke(o)}}}function kt(r){let t,e,s,i;const o=[Et,gt],n=[];function c(l,u){return l[3]?0:1}return e=c(r),s=n[e]=o[e](r),{c(){t=k("div"),s.c(),this.h()},l(l){t=w(l,"DIV",{class:!0});var u=y(t);s.l(u),u.forEach(m),this.h()},h(){T(t,"class","wrapper svelte-eu68uy")},m(l,u){N(l,t,u),n[e].m(t,null),r[24](t),i=!0},p(l,u){let h=e;e=c(l),e===h?n[e].p(l,u):(it(),$(n[h],1,1,()=>{n[h]=null}),st(),s=n[e],s?s.p(l,u):(s=n[e]=o[e](l),s.c()),ee(s,1),s.m(t,null))},i(l){i||(ee(s),i=!0)},o(l){$(s),i=!1},d(l){l&&m(t),n[e].d(),r[24](null)}}}const wt=50;function St(r,t,e){let s;Qe(r,ge,v=>e(3,s=v));const i=-1e3,o=rt();let{poseEstimationEnabled:n=!1}=t,{drawSkeleton:c=!1}=t,{muted:l=!0}=t,{poseEstimationCheckFunction:u=()=>!0}=t,h=null,p,{poseEstimationPrimedPromise:S=new Promise(v=>p=v)}=t,D=!1,b,_,F,C,A,R;const E=new Promise(v=>R=v);let I=new Date().getTime(),V=-1,a=new Date().getTime(),f=-1,d=1,O=1,L=1,j=1,H=1,oe=1;function Se(){b&&(e(17,d=b.videoWidth),e(18,O=b.videoHeight))}let J=null;const te=()=>{_&&(oe>L?(e(2,_.height=H,_),e(2,_.width=H*L,_)):(e(2,_.width=j,_),e(2,_.height=j/L,_)))};function ie(){return e(14,h=Me),e(14,h.onmessage=v=>{if(v.data.type===me.poseEstimation){if(a=new Date().getTime(),v.data.frameId===i){p==null||p();return}const se=lt(v.data.result,(_==null?void 0:_.width)??d,(_==null?void 0:_.height)??O);f=v.data.frameId,J=v.data.result,o("poseEstimationResult",{frameId:v.data.frameId,result:v.data.result,pixelLMs:se})}else v.data.type===me.error||v.data.type===me.resetError?(console.error("PoseEstim Error Message",v.data.type,v.data.error),v.data.frameId===V&&(V=-1,J=null)):v.data.type==me.resetComplete&&console.log("Pose Estimation Reset Complete")},h),Me.postMessage({type:Te.reset,frameId:new Date().getTime()}),h.ready}async function De(){if(!n||!h||!C||!_)throw new Error("Pose estimation not enabled, or not yet ready.");return console.log("Priming pose estimation"),e(7,S=new Promise(v=>p=v)),h.postMessage({type:Te.requestPoseEstimation,frameId:i,image:C.getImageData(0,0,_.width,_.height)}),S}Re(async()=>{n&&ie(),await ot(),te();const v=new ResizeObserver(se=>{if(!F)return;const[X,G]=ct(F);e(19,j=X),e(20,H=G)});return v.observe(F),()=>{h==null||h.terminate(),v.unobserve(F)}});function ne(){!b||!s||(e(1,b.srcObject=s,b),e(15,D=!0),R&&(R(),R=void 0))}let Q=0;function Z(){if(!_||!b||!s||!C)return;Q+=1;const v=b.videoWidth/b.videoHeight,se=_.width/_.height;let X=_.width,G=_.height,le=0,ce=0;if(v>se?(G=_.width/v,ce=(_.height-G)/2):(X=G*v,le=(_.width-X)/2),C.drawImage(b,le,ce,X,G),!(le>=0&&ce>=0&&X>0&&G>0&&se>0&&v>0)){requestAnimationFrame(Z);return}const Ve=new Date().getTime(),xe=Ve-a;if(f==V&&xe>wt&&n&&u()){const re=Ve-I;V=Q,o("poseEstimationFrameSent",{frameId:Q,timestampMs:re}),h==null||h.postMessage({type:Te.requestPoseEstimation,frameId:Q,timestampMs:re,image:C.getImageData(le,ce,X,G)})}if(!c){requestAnimationFrame(Z);return}C.save();for(const re of(J==null?void 0:J.landmarks)??[])A==null||A.drawConnectors(re,ft.POSE_CONNECTIONS),A==null||A.drawLandmarks(re,{radius:$e=>Ue.lerp($e.from.z,-.15,.1,5,1)});C.restore(),requestAnimationFrame(Z)}Re(()=>(ne(),{}));function ye(v){B[v?"unshift":"push"](()=>{b=v,e(1,b)})}function P(){l=this.muted,e(0,l)}function Ie(v){B[v?"unshift":"push"](()=>{_=v,e(2,_)})}function ae(v){B[v?"unshift":"push"](()=>{F=v,e(4,F)})}return r.$$set=v=>{"poseEstimationEnabled"in v&&e(8,n=v.poseEstimationEnabled),"drawSkeleton"in v&&e(9,c=v.drawSkeleton),"muted"in v&&e(0,l=v.muted),"poseEstimationCheckFunction"in v&&e(10,u=v.poseEstimationCheckFunction),"poseEstimationPrimedPromise"in v&&e(7,S=v.poseEstimationPrimedPromise)},r.$$.update=()=>{r.$$.dirty[0]&393216&&(L=d/O),r.$$.dirty[0]&1572864&&(oe=j/H),r.$$.dirty[0]&16640&&n&&!h&&ie(),r.$$.dirty[0]&10&&s&&b&&ne(),r.$$.dirty[0]&1966080&&d&&O&&j&&H&&te(),r.$$.dirty[0]&98310&&D&&b&&_&&(e(16,C=_.getContext("2d",{willReadFrequently:!0})),A=new Ue(C),Z())},[l,b,_,s,F,Se,te,S,n,c,u,E,ie,De,h,D,C,d,O,j,H,ye,P,Ie,ae]}class Dt extends Ee{constructor(t){super(),ke(this,t,St,kt,we,{poseEstimationEnabled:8,drawSkeleton:9,muted:0,poseEstimationCheckFunction:10,poseEstimationPrimedPromise:7,webcamStartedPromise:11,setupPoseEstimation:12,primePoseEstimation:13},null,[-1,-1])}get webcamStartedPromise(){return this.$$.ctx[11]}get setupPoseEstimation(){return this.$$.ctx[12]}get primePoseEstimation(){return this.$$.ctx[13]}}function yt(r,t,e,s){return{startTime:e.start_time,endTime:e.end_time,activityTypes:["drill"],playbackSpeed:.6}}const Ge=Object.freeze([[q.leftShoulder,q.rightShoulder],[q.leftShoulder,q.leftHip],[q.leftHip,q.rightHip],[q.rightHip,q.rightShoulder],[q.leftShoulder,q.leftElbow],[q.leftElbow,q.leftWrist],[q.rightShoulder,q.rightElbow],[q.rightElbow,q.rightWrist]]);function Ze(r){return Math.pow(Math.pow(r[0],2)+Math.pow(r[1],2),.5)}function Be(r,t,e){const{x:s,y:i}=r[t],{x:o,y:n}=r[e],[c,l]=[o-s,n-i],u=Ze([c,l]);return[c/u,l/u]}function It(r,t){return 0}function Pt(r,t){let e=0;for(const p of Ge){const[S,D]=p,[b,_]=Be(r,S,D),[F,C]=Be(t,S,D),[A,R]=[b-F,_-C];e+=Ze([A,R])||0}e/=Ge.length;const s=2,i=0,o=s-i,n=5,l=n-0,u=(e-i)/o,h=n-l*u;return[e,h]}class Tt{constructor(){Pe(this,"tracks",new Map)}recordEvaluationFrame(t,e,s,i){var l;const o=Object.keys(i);this.tracks.has(t)||this.tracks.set(t,{creationDate:new Date,frameTimes:[],userPoses:[],evaluation:o.reduce((u,h)=>(u[h]=[],u),{})});const n=((l=this.tracks.get(t))==null?void 0:l.frameTimes.slice(-1)[0])??-1/0;if(e<n)throw new Error("Frame time must be increasing");const c=this.tracks.get(t);c.frameTimes.push(e),c.userPoses.push(s);for(const u of o)c.evaluation[u].push(i[u])}}class Rt{constructor(t){Pe(this,"recorder",new Tt);this.referenceData=t}evaluateFrame(t,e,s){const i=this.referenceData.getReferencePoseAtTime(e);if(!i){this.recorder.recordEvaluationFrame(t,e,s,{rawQijiaDissimilarityScore:NaN,qijiaPerformanceScore:NaN,julienScore:NaN});return}const[o,n]=Pt(i,s),c=It();this.recorder.recordEvaluationFrame(t,e,s,{rawQijiaDissimilarityScore:o,qijiaPerformanceScore:n,julienScore:c})}getPerformanceSummary(t){const e=this.recorder.tracks.get(t);if(!e)return null;const i=Object.keys(e.evaluation).reduce((l,u)=>{const h=e.evaluation[u].reduce((p,S)=>p+S,0);return l[u]=h/e.evaluation[u].length,l},{}),o=e.frameTimes.length,n=e.frameTimes[o-1]-e.frameTimes[0],c=o/n;return i.frameCount=o,i.duration=n,i.fps=c,i}}function Vt(r){let t,e;return{c(){t=k("source"),this.h()},l(s){t=w(s,"SOURCE",{src:!0,type:!0}),this.h()},h(){Ce(t.src,e=r[9])||T(t,"src",e),T(t,"type","video/mp4")},m(s,i){N(s,t,i)},p(s,i){i[0]&512&&!Ce(t.src,e=s[9])&&T(t,"src",e)},d(s){s&&m(t)}}}function Ye(r){let t,e,s;return{c(){t=k("div"),e=k("span"),s=M(r[13]),this.h()},l(i){t=w(i,"DIV",{class:!0});var o=y(t);e=w(o,"SPAN",{class:!0});var n=y(e);s=U(n,r[13]),n.forEach(m),o.forEach(m),this.h()},h(){T(e,"class","count svelte-3894ek"),T(t,"class","countdown svelte-3894ek")},m(i,o){N(i,t,o),g(t,e),g(e,s)},p(i,o){o[0]&8192&&K(s,i[13])},d(i){i&&m(t)}}}function Je(r){let t,e,s,i,o,n,c,l,u,h,p,S,D,b=JSON.stringify(r[12],null,2)+"",_,F,C;return{c(){t=k("div"),e=k("h1"),s=M("Feedback"),i=W(),o=k("button"),n=M("Play Again"),c=W(),l=k("div"),u=k("strong"),h=M("DancePoseReference"),p=M(r[11]),S=W(),D=k("pre"),_=M(b),this.h()},l(A){t=w(A,"DIV",{class:!0});var R=y(t);e=w(R,"H1",{});var E=y(e);s=U(E,"Feedback"),E.forEach(m),i=z(R),o=w(R,"BUTTON",{class:!0});var I=y(o);n=U(I,"Play Again"),I.forEach(m),c=z(R),l=w(R,"DIV",{});var V=y(l);u=w(V,"STRONG",{});var a=y(u);h=U(a,"DancePoseReference"),a.forEach(m),p=U(V,r[11]),V.forEach(m),S=z(R),D=w(R,"PRE",{});var f=y(D);_=U(f,b),f.forEach(m),R.forEach(m),this.h()},h(){T(o,"class","button outlined thin"),T(t,"class","svelte-3894ek")},m(A,R){N(A,t,R),g(t,e),g(e,s),g(t,i),g(t,o),g(o,n),g(t,c),g(t,l),g(l,u),g(u,h),g(l,p),g(t,S),g(t,D),g(D,_),F||(C=Y(o,"click",r[1]),F=!0)},p(A,R){R[0]&2048&&K(p,A[11]),R[0]&4096&&b!==(b=JSON.stringify(A[12],null,2)+"")&&K(_,b)},d(A){A&&m(t),F=!1,C()}}}function Xe(r){let t,e,s,i,o;return{c(){t=k("div"),e=k("div"),s=W(),i=k("div"),o=M("Loading..."),this.h()},l(n){t=w(n,"DIV",{class:!0});var c=y(t);e=w(c,"DIV",{class:!0}),y(e).forEach(m),s=z(c),i=w(c,"DIV",{class:!0});var l=y(i);o=U(l,"Loading..."),l.forEach(m),c.forEach(m),this.h()},h(){T(e,"class","spinner large"),T(i,"class","label svelte-3894ek"),T(t,"class","loading outlined thick svelte-3894ek")},m(n,c){N(n,t,c),g(t,e),g(t,s),g(t,i),g(i,o)},d(n){n&&m(t)}}}function Ft(r){let t,e,s,i,o,n,c,l,u,h,p,S,D,b;function _(f){r[25](f)}function F(f){r[26](f)}function C(f){r[27](f)}function A(f){r[28](f)}let R={flipHorizontal:r[0],fitToFlexbox:Nt,poseData:r[11],drawSkeleton:!0,$$slots:{default:[Vt]},$$scope:{ctx:r}};r[3]!==void 0&&(R.currentTime=r[3]),r[8]!==void 0&&(R.playbackRate=r[8]),r[5]!==void 0&&(R.paused=r[5]),r[4]!==void 0&&(R.duration=r[4]),s=new ut({props:R}),B.push(()=>fe(s,"currentTime",_)),B.push(()=>fe(s,"playbackRate",F)),B.push(()=>fe(s,"paused",C)),B.push(()=>fe(s,"duration",A));let E=r[13]>=0&&Ye(r),I=r[2]==="feedback"&&Je(r),V={poseEstimationEnabled:r[10],drawSkeleton:!r[5]||r[6],poseEstimationCheckFunction:r[15]};S=new Dt({props:V}),r[29](S),S.$on("poseEstimationFrameSent",r[14]),S.$on("poseEstimationResult",r[16]);let a=r[2]==="waitStart"&&Xe();return{c(){t=k("section"),e=k("div"),_e(s.$$.fragment),l=W(),E&&E.c(),u=W(),I&&I.c(),h=W(),p=k("div"),_e(S.$$.fragment),D=W(),a&&a.c(),this.h()},l(f){t=w(f,"SECTION",{class:!0});var d=y(t);e=w(d,"DIV",{class:!0});var O=y(e);pe(s.$$.fragment,O),l=z(O),E&&E.l(O),O.forEach(m),u=z(d),I&&I.l(d),h=z(d),p=w(d,"DIV",{class:!0});var L=y(p);pe(S.$$.fragment,L),D=z(L),a&&a.l(L),L.forEach(m),d.forEach(m),this.h()},h(){T(e,"class","svelte-3894ek"),T(p,"class","svelte-3894ek"),Ae(p,"display",r[2]==="feedback"?"none":"flex"),T(t,"class","practicePage svelte-3894ek")},m(f,d){N(f,t,d),g(t,e),ve(s,e,null),g(e,l),E&&E.m(e,null),g(t,u),I&&I.m(t,null),g(t,h),g(t,p),ve(S,p,null),g(p,D),a&&a.m(p,null),b=!0},p(f,d){const O={};d[0]&1&&(O.flipHorizontal=f[0]),d[0]&2048&&(O.poseData=f[11]),d[0]&512|d[1]&64&&(O.$$scope={dirty:d,ctx:f}),!i&&d[0]&8&&(i=!0,O.currentTime=f[3],de(()=>i=!1)),!o&&d[0]&256&&(o=!0,O.playbackRate=f[8],de(()=>o=!1)),!n&&d[0]&32&&(n=!0,O.paused=f[5],de(()=>n=!1)),!c&&d[0]&16&&(c=!0,O.duration=f[4],de(()=>c=!1)),s.$set(O),f[13]>=0?E?E.p(f,d):(E=Ye(f),E.c(),E.m(e,null)):E&&(E.d(1),E=null),f[2]==="feedback"?I?I.p(f,d):(I=Je(f),I.c(),I.m(t,h)):I&&(I.d(1),I=null);const L={};d[0]&1024&&(L.poseEstimationEnabled=f[10]),d[0]&96&&(L.drawSkeleton=!f[5]||f[6]),S.$set(L),f[2]==="waitStart"?a||(a=Xe(),a.c(),a.m(p,null)):a&&(a.d(1),a=null),d[0]&4&&Ae(p,"display",f[2]==="feedback"?"none":"flex")},i(f){b||(ee(s.$$.fragment,f),ee(S.$$.fragment,f),b=!0)},o(f){$(s.$$.fragment,f),$(S.$$.fragment,f),b=!1},d(f){f&&m(t),be(s),E&&E.d(),I&&I.d(),r[29](null),be(S),a&&a.d()}}}let Nt=!0;const Ot=10;async function he(r){return new Promise(t=>{setTimeout(t,(r??1)*1e3)})}function At(r,t,e){let s;Qe(r,ge,P=>e(24,s=P));let{dance:i}=t,{practiceActivity:o}=t,n="waitWebcam",c=0,l="watch",u=1,{pageActive:h=!1}=t,{flipVideo:p=!1}=t,S,D=0,b=1,_=0,F=!0,C="",A=!1,R=null,E=null,I=null,V=crypto.randomUUID(),a=null,f=-1,d=!1;async function O(){d||(A&&(console.log("Triggering pose estimation priming"),await S.primePoseEstimation()),e(2,n="playing"),e(23,V=crypto.randomUUID()),e(6,d=!0),e(5,F=!0),e(3,D=(o==null?void 0:o.startTime)??0),e(13,f=5),await he(u),e(13,f=6),await he(u),e(13,f=7),await he(u),e(13,f=8),await he(u),e(13,f=-1),e(5,F=!1),e(6,d=!1))}async function L(){e(20,c=0),e(2,n="waitWebcam"),e(5,F=!0),e(3,D=(o==null?void 0:o.startTime)??0),e(11,E=await at(i)),await S.webcamStartedPromise,e(2,n="waitStart"),e(22,I=new Rt(E)),await R,O()}let j=new Map,H=-1,oe=new Date;const Se=1e3/Ot;function J(P){console.log("poseEstimationFrameSent",P.detail.frameId,D),j.set(P.detail.frameId,D),H=D}function te(){return!(H===D&&oe.getTime()>Date.now()-Se)}function ie(P){var v;if(console.log("poseEstimationFrameReceived",P.detail.frameId,P.detail.result),n!=="playing")return;if(!E){console.log("No dance pose information",P);return}if(!j.has(P.detail.frameId)){console.log(`No matching correspondance for ${P.detail.frameId}`,P,"current correspondances: ",j);return}const Ie=j.get(P.detail.frameId);j.delete(P.detail.frameId);const ae=((v=P==null?void 0:P.detail)==null?void 0:v.pixelLMs)??null;ae&&(I==null||I.evaluateFrame(V,Ie,ae))}Re(()=>(e(3,D=(o==null?void 0:o.startTime)??0),R=S.setupPoseEstimation(),L(),{}));function De(P){D=P,e(3,D)}function ne(P){b=P,e(8,b),e(18,o)}function Q(P){F=P,e(5,F),e(18,o),e(3,D),e(4,_),e(22,I),e(23,V)}function Z(P){_=P,e(4,_)}function ye(P){B[P?"unshift":"push"](()=>{S=P,e(7,S)})}return r.$$set=P=>{"dance"in P&&e(17,i=P.dance),"practiceActivity"in P&&e(18,o=P.practiceActivity),"pageActive"in P&&e(19,h=P.pageActive),"flipVideo"in P&&e(0,p=P.flipVideo)},r.$$.update=()=>{r.$$.dirty[0]&12845080&&(o!=null&&o.endTime&&D>=o.endTime||_>0&&D>=_)&&(e(5,F=!0),e(12,a=(I==null?void 0:I.getPerformanceSummary(V))??null),e(2,n="feedback")),r.$$.dirty[0]&16777220&&s&&n==="waitWebcam"&&e(2,n="waitStart"),r.$$.dirty[0]&4&&console.log("PracticePage state",n),r.$$.dirty[0]&1310720&&o&&e(21,l=o.activityTypes[c]),r.$$.dirty[0]&131072&&(u=i!=null&&i.bpm?60/i.bpm:1),r.$$.dirty[0]&16&&console.log("VideoDuration",_),r.$$.dirty[0]&131072&&e(9,C=nt(i)),r.$$.dirty[0]&2621536&&e(10,A=h&&(d||!F)&&l==="drill"),r.$$.dirty[0]&262144&&e(8,b=(o==null?void 0:o.playbackSpeed)??1)},[p,L,n,D,_,F,d,S,b,C,A,E,a,f,J,te,ie,i,o,h,c,l,I,V,s,De,ne,Q,Z,ye]}class Ct extends Ee{constructor(t){super(),ke(this,t,At,Ft,we,{dance:17,practiceActivity:18,pageActive:19,flipVideo:0,reset:1},null,[-1,-1])}get reset(){return this.$$.ctx[1]}}function Lt(r){let t,e,s,i,o,n=r[2].tree_name+"",c,l;return e=new Ct({props:{dance:r[1],practiceActivity:r[3],pageActive:!0}}),{c(){t=k("section"),_e(e.$$.fragment),s=W(),i=k("a"),o=M("< "),c=M(n),this.h()},l(u){t=w(u,"SECTION",{class:!0});var h=y(t);pe(e.$$.fragment,h),s=z(h),i=w(h,"A",{href:!0,class:!0});var p=y(i);o=U(p,"< "),c=U(p,n),p.forEach(m),h.forEach(m),this.h()},h(){T(i,"href",r[0]),T(i,"class","button outlined back svelte-4dzpk3"),T(t,"class","practiceNode svelte-4dzpk3")},m(u,h){N(u,t,h),ve(e,t,null),g(t,s),g(t,i),g(i,o),g(i,c),l=!0},p(u,[h]){(!l||h&1)&&T(i,"href",u[0])},i(u){l||(ee(e.$$.fragment,u),l=!0)},o(u){$(e.$$.fragment,u),l=!1},d(u){u&&m(t),be(e)}}}function Mt(r,t,e){let{data:s}=t;const i=s.dance,o=s.danceTree,n=s.danceTreeNode,c=yt(i,o,n);let l="/teachlesson/"+Le(o);return r.$$set=u=>{"data"in u&&e(4,s=u.data)},e(0,l="/teachlesson/"+Le(o)),[l,i,o,c,s]}class Jt extends Ee{constructor(t){super(),ke(this,t,Mt,Lt,we,{data:4})}}export{Jt as default};
